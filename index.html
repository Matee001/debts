<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debt Tracker with Login</title>
    <style>
        /* Basic styling */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #121212;
            font-family: Arial, sans-serif;
            color: #ffffff;
        }

        /* Container for main content */
        .container {
            background: rgba(33, 33, 33, 0.9);
            padding: 30px;
            width: 320px;
            border-radius: 15px;
            box-shadow: 0px 10px 30px rgba(0, 0, 0, 0.7);
            display: none; /* Hidden until login */
        }

        /* Login popup styling */
        .login-popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(48, 48, 48, 0.9);
            padding: 20px;
            width: 300px;
            border-radius: 15px;
            box-shadow: 0px 10px 30px rgba(0, 0, 0, 0.7);
            text-align: center;
        }

        .login-popup h2 {
            color: #90caf9;
            margin-bottom: 20px;
        }

        .login-popup input {
            width: 80%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: none;
        }

        .login-popup button {
            background-color: #90caf9;
            color: #121212;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        /* Displaying the total debt */
        .total {
            font-size: 26px;
            font-weight: bold;
            color: #90caf9;
            text-align: center;
            margin-bottom: 20px;
        }

        /* Transaction styling */
        .transactions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .transaction {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            border-radius: 10px;
            background: rgba(48, 48, 48, 0.8);
            box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.5);
            transition: transform 0.2s;
        }

        .transaction.debt div:first-child {
            color: #e57373;
            font-weight: bold;
        }

        .transaction.payment div:first-child {
            color: #81c784;
            font-weight: bold;
        }

        /* Style for the 'Show All' and 'Show Less' buttons */
        .show-button {
            background-color: #90caf9;
            color: #121212;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            text-align: center;
            margin-top: 15px;
        }
    </style>
</head>
<body>

    <!-- Login Popup -->
    <div id="login-popup" class="login-popup">
        <h2>Login</h2>
        <form id="login-form">
            <input type="email" id="email" placeholder="Email" autocomplete="username" required />
            <input type="password" id="password" placeholder="Password" autocomplete="current-password" required />
            <button type="button" onclick="login()">Login</button>
        </form>
        <div id="login-error" style="color: red; margin-top: 10px;"></div>
    </div>

    <!-- Main Container (hidden until login) -->
    <div class="container" id="main-container">
        <div id="total-debt" class="total">Loading...</div>
        <div id="transaction-list" class="transactions"></div>
        <button id="toggle-transactions-button" class="show-button" onclick="toggleTransactions()">Show All</button>
    </div>

    <script type="module">
        // Import Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDl6hnUPdneEuC9emWbELvYoplR8vWhEsA",
            authDomain: "debts-92f72.firebaseapp.com",
            projectId: "debts-92f72",
            storageBucket: "debts-92f72.appspot.com",
            messagingSenderId: "904817355212",
            appId: "1:904817355212:web:fd6837ba25f57d0ec6d569"
        };

        // Initialize Firebase and Firestore
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Login Function using Firebase Auth
        async function login() {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            const loginError = document.getElementById("login-error");

            try {
                // Sign in the user with Firebase Auth
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Hide login popup and show main content
                document.getElementById("login-popup").style.display = "none";
                document.getElementById("main-container").style.display = "block";

                // Load user-specific transactions
                loadTransactions(user.uid);
            } catch (error) {
                console.error("Login error:", error);
                loginError.innerText = "Invalid email or password.";
            }
        }

        // Expose the login function globally
        window.login = login;

        let allTransactions = [];
        const TRANSACTION_LIMIT = 5;

        // Load user-specific transactions from the Firestore collection named by UID
        async function loadTransactions(uid) {
            const transactionsRef = collection(db, uid);
            try {
                const transactionSnapshot = await getDocs(transactionsRef);

                let totalDebt = 0;
                allTransactions = [];

                transactionSnapshot.forEach((doc) => {
                    const data = doc.data();
                    const type = data.type.replace(/^"|"$/g, '');
                    const date = data.date.replace(/^"|"$/g, '');
                    const amount = Number(data.amount);

                    allTransactions.push({ ...data, type, date });

                    if (type === "debt") {
                        totalDebt -= amount;
                    } else if (type === "payment") {
                        totalDebt += amount;
                    }
                });

                document.getElementById("total-debt").innerText = `${totalDebt} Ft`;
                renderTransactions(allTransactions.slice(0, TRANSACTION_LIMIT));
            } catch (error) {
                console.error("Error loading transactions:", error);
                document.getElementById("total-debt").innerText = "Error loading transactions.";
            }
        }

        // Render the list of transactions
        function renderTransactions(transactions) {
            const transactionContainer = document.getElementById("transaction-list");
            transactionContainer.innerHTML = "";

            transactions.forEach((transaction) => {
                const transactionElement = document.createElement("div");
                transactionElement.className = `transaction ${transaction.type}`;
                const sign = transaction.type === "debt" ? "-" : "+";
                transactionElement.innerHTML = `
                    <div>${sign}${transaction.amount} Ft</div>
                    <div>${transaction.date}</div>
                `;
                transactionContainer.appendChild(transactionElement);
            });
        }

        // Toggle between "Show All" and "Show Less" functionality
        function toggleTransactions() {
            const button = document.getElementById("toggle-transactions-button");
            if (button.innerText === "Show All") {
                renderTransactions(allTransactions);
                button.innerText = "Show Less";
            } else {
                renderTransactions(allTransactions.slice(0, TRANSACTION_LIMIT));
                button.innerText = "Show All";
            }
        }

        window.toggleTransactions = toggleTransactions;
    </script>
</body>
</html>
