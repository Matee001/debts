<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
    <h1>Admin Dashboard</h1>
    
    <!-- Login Form -->
    <div id="loginForm">
        <h2>Login</h2>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button onclick="login()">Login</button>
        <p id="errorMessage" style="color: red;"></p>
    </div>

    <!-- Main Admin Dashboard (Visible after login) -->
    <div id="adminDashboard" style="display: none;">
        <button onclick="logout()">Logout</button>
        
        <h2>Select User</h2>
        <select id="userDropdown" onchange="fetchTransactions(this.value)">
            <option value="">Select a User</option>
        </select>

        <h2>User Transactions</h2>
        <table id="transactionsTable" border="1">
            <thead>
                <tr>
                    <th>Amount</th>
                    <th>Date</th>
                    <th>Type</th>
                </tr>
            </thead>
            <tbody id="transactionsList">
                <!-- Transactions will be listed here -->
            </tbody>
        </table>

        <h2>Add Transaction</h2>
        <input type="number" id="amount" placeholder="Amount">
        <input type="text" id="date" placeholder="Date (e.g., '11.09')">
        <select id="type">
            <option value="payment">Payment</option>
            <option value="debt">Debt</option>
        </select>
        <button onclick="addTransaction()">Add Transaction</button>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDl6hnUPdneEuC9emWbELvYoplR8vWhEsA",
            authDomain: "debts-92f72.firebaseapp.com",
            projectId: "debts-92f72",
            storageBucket: "debts-92f72.firebaseapp.com",
            messagingSenderId: "904817355212",
            appId: "1:904817355212:web:0e50faa2c6ac4d5ec6d569"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Login function
        function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorMessage = document.getElementById('errorMessage');
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    if (user.uid === "01bLIykolnQuLHBsX7Ca5BKwMMo1") {
                        // Hide login form and show admin dashboard
                        document.getElementById('loginForm').style.display = 'none';
                        document.getElementById('adminDashboard').style.display = 'block';
                        fetchUsers();
                    } else {
                        errorMessage.textContent = "You are not authorized to access the admin panel.";
                        auth.signOut();
                    }
                })
                .catch((error) => {
                    console.error("Error logging in: ", error);
                    document.getElementById('errorMessage').textContent = "Failed to log in: " + error.message;
                });
        }

        // Fetch the list of users from the 'login' collection
        async function fetchUsers() {
            try {
                const usersSnapshot = await db.collection("login").get();
                const userDropdown = document.getElementById('userDropdown');
                userDropdown.innerHTML = '<option value="">Select a User</option>'; // Clear previous options

                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    const option = document.createElement("option");
                    option.value = doc.id;  // The document ID is the user's UID
                    option.textContent = `${userData.name} (${userData.email.replace(/\"/g, '')})`; // Remove extra quotes in email
                    userDropdown.appendChild(option);
                });
            } catch (error) {
                console.error("Error fetching users: ", error);
                alert("Error fetching users. Check the console for details.");
            }
        }

        // Fetch transactions for the selected user
        async function fetchTransactions(userUid) {
            if (!userUid) return;
            
            try {
                const transactionsSnapshot = await db.collection(userUid).get();
                const transactionsList = document.getElementById('transactionsList');
                transactionsList.innerHTML = '';  // Clear previous transactions table

                // Loop through each transaction and add it to the table
                transactionsSnapshot.forEach(doc => {
                    const transaction = doc.data();
                    const row = document.createElement("tr");

                    const amountCell = document.createElement("td");
                    amountCell.textContent = transaction.amount;
                    row.appendChild(amountCell);

                    const dateCell = document.createElement("td");
                    dateCell.textContent = transaction.date;
                    row.appendChild(dateCell);

                    const typeCell = document.createElement("td");
                    typeCell.textContent = transaction.type;
                    row.appendChild(typeCell);

                    transactionsList.appendChild(row);
                });
            } catch (error) {
                console.error("Error fetching transactions: ", error);
                alert("Error fetching transactions.");
            }
        }

        // Add a new transaction to the selected user's collection
        async function addTransaction() {
            const userUid = document.getElementById('userDropdown').value;
            const amount = document.getElementById('amount').value;
            const date = document.getElementById('date').value;
            const type = document.getElementById('type').value;

            if (!userUid || !amount || !date || !type) {
                alert("Please fill in all fields.");
                return;
            }

            try {
                // Add the new transaction to the selected user's collection
                await db.collection(userUid).add({
                    amount: parseInt(amount),
                    date: date,
                    type: type
                });

                alert("Transaction added successfully!");
                fetchTransactions(userUid);  // Refresh the transaction list
            } catch (error) {
                console.error("Error adding transaction: ", error);
                alert("Failed to add transaction.");
            }
        }

        // Log out the admin
        function logout() {
            firebase.auth().signOut()
                .then(() => {
                    // Show the login form again
                    document.getElementById('loginForm').style.display = 'block';
                    document.getElementById('adminDashboard').style.display = 'none';
                })
                .catch((error) => {
                    console.error("Error logging out: ", error);
                });
        }
    </script>
</body>
</html>
